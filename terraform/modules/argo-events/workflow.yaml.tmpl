apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: go-app-build
  namespace: ${namespace}
spec:
  serviceAccountName: argo-workflows-server
  entrypoint: build-and-push-steps
  # Global nodeSelector to ensure all pods run on the same node
  nodeSelector:
    kubernetes.io/hostname: "${target_node_host_path}"  # Replace with actual node name
    # Or use labels like: node-role.kubernetes.io/worker: "true"
  templates:
    # Main workflow with sequential steps
    - name: build-and-push-steps
      steps:
      - - name: git-clone
          template: git-clone
      - - name: kaniko-build
          template: kaniko-build

    # Git clone template
    - name: git-clone
      nodeSelector:
        kubernetes.io/hostname: "${target_node_host_path}"  # Replace with actual node name
      container:
        image: alpine/git
        command: ["sh", "-c"]
        args:
        - |
          echo "Cloning repository..."
          # Clean the directory first in case of previous runs
          rm -rf /shared-workspace/source
          mkdir -p /shared-workspace/source
          git clone ${repo_url} /shared-workspace/source
          ls -la /shared-workspace/source
          echo "Repository cloned successfully"
        volumeMounts:
        - name: shared-workspace
          mountPath: /shared-workspace

    # Kaniko build template
    - name: kaniko-build
      nodeSelector:
        kubernetes.io/hostname: "${target_node_host_path}"  # Replace with actual node name
      container:
        image: gcr.io/kaniko-project/executor:latest
        command:
        - /kaniko/executor
        args:
        - --dockerfile=/shared-workspace/source/Dockerfile
        - --context=dir:///shared-workspace/source
        - --destination=${ecr_repo_url}:latest
        - --cache=true
        - --cache-ttl=24h
        volumeMounts:
        - name: shared-workspace
          mountPath: /shared-workspace
        - name: kaniko-secret
          mountPath: /kaniko/.docker
  volumes:
    - name: shared-workspace
      hostPath:
        path: /tmp/argo-workspace-{{workflow.uid}}  # Unique path per workflow
        type: DirectoryOrCreate
    - name: kaniko-secret
      secret:
        secretName: kaniko-docker-config